// JayData 1.1.1
// Dual licensed under MIT and GPL v2
// Copyright JayStack Technologies (http://jaydata.org/licensing)
//
// JayData is a standards-based, cross-platform Javascript library and a set of
// practices to access and manipulate data from various online and offline sources.
//
// Credits:
//     Hajnalka Battancs, Dániel József, János Roden, László Horváth, Péter Nochta
//     Péter Zentai, Róbert Bónay, Szabolcs Czinege, Viktor Borza, Viktor Lázár,
//     Zoltán Gyebrovszki
//
// More info: http://jaydata.org
$C("$data.modelBinder.mongoDBModelBinderConfigCompiler",$data.modelBinder.ModelBinderConfigCompiler,null,{_addPropertyToModelBinderConfig:function(b,a){var c=this._query.context._storageModel.getStorageModel(b);b.memberDefinitions?b.memberDefinitions.getPublicMappedProperties().forEach(function(b){if(!c||c&&!c.Associations[b.name]&&!c.ComplexTypes[b.name])if(!c&&0>this._query.context.storageProvider.supportedDataTypes.indexOf(Container.resolveType(b.dataType)))a.selectModelBinderProperty(b.name),
a.modelBinderConfig.$type=Container.resolveType(b.dataType),a.modelBinderConfig.$selector=this._isoDataProvider?["json:"+b.name+".results","json:"+b.name]:"json:"+b.name,this._addPropertyToModelBinderConfig(Container.resolveType(b.dataType),a),a.popModelBinderProperty();else if(b.key&&a.addKeyField(b.computed?"_id":b.name),b.concurrencyMode===$data.ConcurrencyMode.Fixed)a.modelBinderConfig[b.name]={$selector:"json:__metadata",$source:"etag"};else{var h=Container.resolveType(b.dataType);a.modelBinderConfig[b.name]=
h===$data.Array||h===$data.Object?{$type:h,$source:b.name}:b.computed?"_id":b.name}},this):(a._binderConfig.$item=a._binderConfig.$item||{},a.modelBinderConfig=a._binderConfig.$item);c&&this._addComplexTypeProperties(c.ComplexTypes,a)},_addComplexType:function(b,a){if(b.ToType!==$data.Array)a.modelBinderConfig.$type=b.ToType,a.modelBinderConfig.$selector=this._isoDataProvider?["json:"+b.FromPropertyName+".results","json:"+b.FromPropertyName]:"json:"+b.FromPropertyName,this._addPropertyToModelBinderConfig(b.ToType,
a);else{var c=b.ToType,d=Container.resolveType(b.FromType.memberDefinitions.getMember(b.FromPropertyName).elementType);if(c===$data.Array&&d&&d.isAssignableTo&&d.isAssignableTo($data.Entity)){config={$type:$data.Array,$selector:"json:"+b.FromPropertyName,$item:{$type:d}};c=d.memberDefinitions.getPublicMappedProperties();for(d=0;d<c.length;d++)config.$item[c[d].name]={$type:c[d].type,$source:c[d].name};$data.typeSystem.extend(a.modelBinderConfig,config)}else c===$data.Array&&d===$data.ObjectID?$data.typeSystem.extend(a.modelBinderConfig,
{$type:$data.Array,$selector:"json:"+b.FromPropertyName,$item:{$type:$data.ObjectID,$value:function(a,b){var c=Container.resolveName(a.$type),d=this.context.storageProvider.fieldConverter.fromDb;return d&&d[c]?d[c](b):new (Container.resolveType(c))(b)}}}):$data.typeSystem.extend(a.modelBinderConfig,{$type:b.ToType,$source:b.FromPropertyName})}},_addComplexTypeProperties:function(b,a){var c=this;b.forEach(function(b){a.selectModelBinderProperty(b.FromPropertyName);c._addComplexType(b,a);a.popModelBinderProperty()},
this)},VisitComplexTypeExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a);if("$selector"in a.modelBinderConfig&&0<a.modelBinderConfig.$selector.length)if(a.modelBinderConfig.$selector instanceof $data.Array){var c=a.modelBinderConfig.$selector[1];a.modelBinderConfig.$selector[0]=c+"."+b.selector.memberName+".results";a.modelBinderConfig.$selector[1]=c+"."+b.selector.memberName}else{var c=Container.resolveType(b.selector.memberDefinition.type),d=c===$data.Array&&b.selector.memberDefinition.elementType?
Container.resolveType(b.selector.memberDefinition.elementType):c;d.memberDefinitions.getMember(b.selector.memberName)&&(a.modelBinderConfig.$selector+="."+b.selector.memberName)}else if(c=Container.resolveType(b.selector.memberDefinition.type),d=c===$data.Array&&b.selector.memberDefinition.elementType?Container.resolveType(b.selector.memberDefinition.elementType):void 0,c===$data.Array&&d&&d.isAssignableTo&&d.isAssignableTo($data.Entity))this._addComplexType(b.selector.memberDefinition.storageModel.ComplexTypes[b.selector.memberDefinition.name],
a);else if(a.modelBinderConfig.$source=b.selector.memberName,c!==$data.Array&&(a.modelBinderConfig.$selector="json:"+b.selector.memberDefinition.name),a._binderConfig.$item===a.modelBinderConfig&&b.selector.memberDefinition.storageModel&&b.selector.memberDefinition.storageModel.ComplexTypes[b.selector.memberDefinition.name])a.modelBinderConfig.$selectorMemberInfo=a.modelBinderConfig.$selector,delete a.modelBinderConfig.$selector},VisitMemberInfoExpression:function(b,a){var c=Container.resolveType(b.memberDefinition.type),
d=c===$data.Array&&b.memberDefinition.elementType?Container.resolveType(b.memberDefinition.elementType):void 0;a.modelBinderConfig.$type=c;c===$data.Array&&d&&d.isAssignableTo&&d.isAssignableTo($data.Entity)?this._addComplexType(b.memberDefinition.storageModel.ComplexTypes[b.memberName],a):b.memberDefinition.storageModel&&b.memberName in b.memberDefinition.storageModel.ComplexTypes?this._addPropertyToModelBinderConfig(Container.resolveType(b.memberDefinition.type),a):a._binderConfig.$item===a.modelBinderConfig?
a._binderConfig.$item={$type:a.modelBinderConfig.$type,$selector:a.modelBinderConfig.$selectorMemberInfo,$source:b.memberDefinition.computed?"_id":b.memberName}:a.modelBinderConfig.$source=b.memberDefinition.computed?"_id":b.memberName}});
$C("$data.storageProviders.mongoDB.mongoDBProjectionCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(){},compile:function(b,a){this.Visit(b,a);delete a.current;delete a.complexType},VisitProjectionExpression:function(b,a){this.Visit(b.selector,a)},VisitParametricQueryExpression:function(b,a){this.Visit(b.expression,a)},VisitObjectLiteralExpression:function(b,a){this.hasObjectLiteral=!0;b.members.forEach(function(b){this.Visit(b,a)},this)},VisitObjectFieldExpression:function(b,
a){this.Visit(b.expression,a)},VisitComplexTypeExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitEntityFieldExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitEntityExpression:function(b,a){this.Visit(b.source,a)},VisitEntitySetExpression:function(b,a){b.source instanceof $data.Expressions.EntityExpression&&this.Visit(b.source,a);b.selector instanceof $data.Expressions.AssociationInfoExpression&&this.Visit(b.selector,a)},VisitAssociationInfoExpression:function(){},
VisitMemberInfoExpression:function(b,a){a.options.fields||(a.options.fields={_id:1});a.current=b.memberName;a.complexType?(delete a.options.fields[a.complexType],a.options.fields[a.complexType+"."+a.current]=1,delete a.complexType):a.options.fields[b.memberName]||(a.options.fields[b.memberName]=1)},VisitConstantExpression:function(){}});
$C("$data.storageProviders.mongoDB.mongoDBWhereCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(b,a){this.provider=b;this.lambdaPrefix=a},compile:function(b,a){this.Visit(b,a)},VisitParametricQueryExpression:function(b,a){this.Visit(b.expression,a)},VisitUnaryExpression:function(b,a){a.unary=b.nodeType;this.Visit(b.operand,a)},VisitSimpleBinaryExpression:function(b,a){a.cursor||(a.query={},a.cursor=a.query);var c=a.cursor;switch(b.nodeType){case $data.Expressions.ExpressionType.Or:if(a.cursor instanceof
Array){var d={$or:[]};a.cursor.push(d);a.cursor=d.$or}else a.cursor.$or=[],a.cursor=a.cursor.$or;this.Visit(b.left,a);this.Visit(b.right,a);a.cursor=c;break;case $data.Expressions.ExpressionType.And:a.cursor instanceof Array?(d={$and:[]},a.cursor.push(d),a.cursor=d.$and):(a.cursor.$and=[],a.cursor=a.cursor.$and);this.Visit(b.left,a);this.Visit(b.right,a);a.cursor=c;break;case $data.Expressions.ExpressionType.Equal:case $data.Expressions.ExpressionType.EqualTyped:this.Visit(b.left,a);this.Visit(b.right,
a);a.queryField=a.field;!a.complexType&&a.entityType&&a.entityType.memberDefinitions.getMember(a.field).computed&&(delete a.query[a.field],a.queryField="_id");c=a.value;a.entityType&&a.entityType.memberDefinitions?c=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.entityType.memberDefinitions.getMember(a.complexType?a.lastField:a.field).type))](c):a.valueType&&(c=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.valueType))](c));a.value=
c;a.cursor instanceof Array?(c={},c[a.queryField]=a.value,a.cursor.push(c)):a.cursor[a.queryField]=a.value;break;case $data.Expressions.ExpressionType.In:this.Visit(b.left,a);this.Visit(b.right,a);a.queryField=a.field;!a.complexType&&a.entityType&&a.entityType.memberDefinitions.getMember(a.field).computed&&(delete a.query[a.field],a.queryField="_id");c=a.value;if(c instanceof Array)for(d=0;d<c.length;d++)a.entityType&&a.entityType.memberDefinitions?c[d]=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.entityType.memberDefinitions.getMember(a.complexType?
a.lastField:a.field).type))](c[d]):a.valueType&&(c[d]=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.valueType))](c[d]));a.value=c;a.cursor instanceof Array?(c={},c[a.queryField]={},a.entityType&&a.entityType===$data.Array?c[a.queryField]=a.unary===$data.Expressions.ExpressionType.Not?{$not:a.value}:a.value:c[a.queryField][a.unary===$data.Expressions.ExpressionType.Not?"$nin":b.resolution.mapTo]=a.value,a.cursor.push(c)):(a.cursor[a.queryField]={},a.entityType&&a.entityType===
$data.Array?a.cursor[a.queryField]=a.unary===$data.Expressions.ExpressionType.Not?{$not:a.value}:a.value:a.cursor[a.queryField][a.unary===$data.Expressions.ExpressionType.Not?"$nin":b.resolution.mapTo]=a.value);a.unary===$data.Expressions.ExpressionType.Not&&(a.unary=void 0);break;default:(this.Visit(b.left,a),this.Visit(b.right,a),a.queryField=a.field,!a.complexType&&a.entityType&&a.entityType.memberDefinitions.getMember(a.field).computed&&(delete a.query[a.field],a.queryField="_id"),c=a.value,a.entityType&&
a.entityType.memberDefinitions?c=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.entityType.memberDefinitions.getMember(a.complexType?a.lastField:a.field).type))](c):a.valueType&&(c=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.valueType))](c)),a.value=c,a.cursor instanceof Array)?(c={},c[a.queryField]={},c[a.queryField][b.resolution.mapTo]=a.value,a.cursor.push(c)):(a.cursor[a.queryField]={},a.cursor[a.queryField][b.resolution.mapTo]=
a.value)}delete a.complexType;delete a.field;delete a.value},VisitEntityFieldExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitAssociationInfoExpression:function(b,a){a.data+=b.associationInfo.FromPropertyName},VisitMemberInfoExpression:function(b,a){a.field=a.complexType&&a.field?a.field+"."+b.memberName:b.memberName;a.complexType&&(a.lastField=b.memberName)},VisitComplexTypeExpression:function(b,a){a.complexType=!0;this.Visit(b.source,a);this.Visit(b.selector,a);a.entityType=
b.entityType},VisitQueryParameterExpression:function(b,a){a.data+=this.provider.fieldConverter.toDb[b.type](b.value)},VisitEntityFieldOperationExpression:function(b,a){Guard.requireType("expression.operation",b.operation,$data.Expressions.MemberInfoExpression);this.Visit(b.source.selector,a);var c=b.operation.memberDefinition,d=c.mapTo||c.name,h=0;(c.parameters||[{name:"@expression"}]).map(function(a){return"@expression"===a.name?b.source:b.parameters[h++]}).forEach(function(b){this.Visit(b,a)},this);
var g,f;switch(d){case "contains":g="$regex";f=a.value;break;case "startsWith":g="$regex";f="^"+a.value;break;case "endsWith":g="$regex",f=a.value+"$"}g&&f&&(a.cursor instanceof Array?(c={},c[a.field]={},c[a.field][g]=f,a.cursor.push(c)):(a.cursor[a.field]={},a.cursor[a.field][g]=f))},VisitConstantExpression:function(b,a){var c=Container.getTypeName(b.value);a.valueType=c;a.value=b.value},VisitEntityExpression:function(b,a){a.entityType=b.entityType;this.Visit(b.source,a)},VisitEntitySetExpression:function(b,
a){this.Visit(b.source,a);b.selector instanceof $data.Expressions.AssociationInfoExpression&&(this.Visit(b.selector,a),a.data+="/")},VisitFrameOperationExpression:function(b,a){this.Visit(b.source,a);Guard.requireType("expression.operation",b.operation,$data.Expressions.MemberInfoExpression);var c=b.operation.memberDefinition;a.data+=c.mapTo||c.name;a.data+="(";for(var d=0,h=(c.parameters||[{name:"@expression"}]).map(function(a){return"@expression"===a.name?b.source:b.parameters[d++]}),g=0;g<h.length;g++){var f=
h[g];if(f.value instanceof $data.Queryable){var e=new c.frameType(f.value.expression),f=(new $data.Expressions.QueryExpressionCreator(f.value.entityContext)).Visit(e),e={data:""};(new $data.storageProviders.mongoDB.mongoDBWhereCompiler(this.provider,!0)).compile(f,e);a.data+=e.lambda+": "+e.data}}a.data+=")"}});
$C("$data.storageProviders.mongoDB.mongoDBOrderCompiler",$data.storageProviders.mongoDB.mongoDBWhereCompiler,null,{constructor:function(b){this.provider=b},compile:function(b,a){this.Visit(b,a)},VisitOrderExpression:function(b,a){var c={data:""};this.Visit(b.selector,c);a.options.sort||(a.options.sort={});a.options.sort[c.data]=b.nodeType==$data.Expressions.ExpressionType.OrderByDescending?-1:1},VisitParametricQueryExpression:function(b,a){this.Visit(b.expression,a)},VisitEntityFieldExpression:function(b,
a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitComplexTypeExpression:function(b,a){this.Visit(b.source,a);a.data&&(a.data+=".");this.Visit(b.selector,a)},VisitEntitySetExpression:function(b,a){b.selector instanceof $data.Expressions.AssociationInfoExpression&&(this.Visit(b.source,a),this.Visit(b.selector,a))},VisitAssociationInfoExpression:function(){},VisitEntityExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitMemberInfoExpression:function(b,a){a.data+=b.memberName}});
$C("$data.storageProviders.mongoDB.mongoDBPagingCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(b){this.provider=b},compile:function(b,a){this.Visit(b,a)},VisitPagingExpression:function(b,a){var c={data:0};this.Visit(b.amount,c);switch(b.nodeType){case $data.Expressions.ExpressionType.Skip:a.options.skip=c.data;break;case $data.Expressions.ExpressionType.Take:a.options.limit=c.data;break;default:Guard.raise("Not supported nodeType")}},VisitConstantExpression:function(b,
a){a.data+=b.value}});
$C("$data.storageProviders.mongoDB.mongoDBCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(){this.context={};this.provider={};this.mainEntitySet=this.includes=null},compile:function(b){this.provider=b.context.storageProvider;this.context=b.context;this.mainEntitySet=b.context.getEntitySetFromElementType(b.defaultType);b.find={query:{},options:{}};b.modelBinderConfig={};(new $data.modelBinder.mongoDBModelBinderConfigCompiler(b,this.includes,!1)).Visit(b.expression);this.Visit(b.expression,
b.find);delete b.find.field;delete b.find.value;delete b.find.data;delete b.find.stack;delete b.find.or;return b},VisitOrderExpression:function(b,a){this.Visit(b.source,a);(new $data.storageProviders.mongoDB.mongoDBOrderCompiler(this.provider)).compile(b,a)},VisitPagingExpression:function(b,a){this.Visit(b.source,a);(new $data.storageProviders.mongoDB.mongoDBPagingCompiler).compile(b,a)},VisitFilterExpression:function(b,a){this.Visit(b.source,a);var c=new $data.storageProviders.mongoDB.mongoDBWhereCompiler(this.provider);
a.data="";c.compile(b.selector,a)},VisitProjectionExpression:function(b,a){this.Visit(b.source,a);(new $data.storageProviders.mongoDB.mongoDBProjectionCompiler(this.context)).compile(b,a)}});
$C("$data.storageProviders.mongoDB.mongoDBProvider",$data.StorageProviderBase,null,{constructor:function(b,a){this.driver=$data.mongoDBDriver;this.context=a;this.providerConfiguration=$data.typeSystem.extend({dbCreation:$data.storageProviders.DbCreationType.DropTableIfChanged,address:"127.0.0.1",port:27017,serverOptions:{},databaseName:"test"},b);if(this.providerConfiguration.server&&("string"===typeof this.providerConfiguration.server&&(this.providerConfiguration.server=[{address:this.providerConfiguration.server.split(":")[0]||
"127.0.0.1",port:this.providerConfiguration.server.split(":")[1]||27017}]),this.providerConfiguration.server instanceof Array||(this.providerConfiguration.server=[this.providerConfiguration.server]),1==this.providerConfiguration.server.length))this.providerConfiguration.address=this.providerConfiguration.server[0].address||"127.0.0.1",this.providerConfiguration.port=this.providerConfiguration.server[0].port||27017,delete this.providerConfiguration.server},_getServer:function(){if(this.providerConfiguration.server){for(var b=
[],a=0;a<this.providerConfiguration.server.length;a++){var c=this.providerConfiguration.server[a];b.push(new this.driver.Server(c.address,c.port,c.serverOptions))}return new this.driver.ReplSetServers(b)}return this.driver.Server(this.providerConfiguration.address,this.providerConfiguration.port,this.providerConfiguration.serverOptions)},initializeStore:function(b){var a=this,b=$data.typeSystem.createCallbackSetting(b);switch(this.providerConfiguration.dbCreation){case $data.storageProviders.DbCreationType.DropAllExistingTables:(new this.driver.Db(this.providerConfiguration.databaseName,
this._getServer(),{})).open(function(c,d){if(c)b.error(c);else{var h=function(c,d){var e=0,h;for(h in a.context._entitySetReferences)a.context._entitySetReferences.hasOwnProperty(h)&&e++;for(h in a.context._entitySetReferences)a.context._entitySetReferences.hasOwnProperty(h)&&d.dropCollection(a.context._entitySetReferences[h].tableName,function(){0==--e&&(b.success(a.context),d.close())})};a.providerConfiguration.username?d.authenticate(a.providerConfiguration.username,a.providerConfiguration.password||
"",function(a,c){a?b.error(a):c&&h(a,d)}):h(c,d)}});break;default:b.success(this.context)}},executeQuery:function(b,a){var c=this,a=$data.typeSystem.createCallbackSetting(a),d=b.context.getEntitySetFromElementType(b.defaultType);(new $data.storageProviders.mongoDB.mongoDBCompiler).compile(b);(new this.driver.Db(this.providerConfiguration.databaseName,this._getServer(),{})).open(function(h,g){if(h)a.error(h);else{var f=new c.driver.Collection(g,d.tableName),e=b.find,n=function(d,f){d?a.error(d):(b.rawDataList=
f instanceof Array?f:[{cnt:f}],b.context=c.context,a.success(b),g.close())},s=function(){switch(b.expression.nodeType){case $data.Expressions.ExpressionType.Count:f.find(e.query,e.options).count(n);break;case $data.Expressions.ExpressionType.BatchDelete:f.remove(e.query,{safe:!0},n);break;default:f.find(e.query,e.options).toArray(n)}};c.providerConfiguration.username?g.authenticate(c.providerConfiguration.username,c.providerConfiguration.password,function(b,c){b?a.error(b):c&&s()}):s()}})},_typeFactory:function(b,
a,c){b=Container.resolveName(b);return c&&c[b]?c[b](a):new (Container.resolveType(b))(a)},_saveCollections:function(b,a){var c=this,d=0,h=this._getServer(),g=0,f=function(a){0==--g&&a()},e=function(a,f,g){for(var e=[],h=0;h<f.insertAll.length;h++){for(var m=f.insertAll[h],o=Container.resolveType(m.type).memberDefinitions.getPublicMappedProperties(),k=0;k<o.length;k++){var i=o[k];if(i.concurrencyMode===$data.ConcurrencyMode.Fixed)m.data[i.name]=0;else if(i.computed)"string"===typeof m.data[i.name]&&
(m.data._id=c._typeFactory(i.type,m.data[i.name],c.fieldConverter.toDb));else{if(Container.resolveType(i.type)===$data.Array&&i.elementType&&Container.resolveType(i.elementType)===$data.ObjectID){m.data[i.name]=c._typeFactory(i.type,m.data[i.name],c.fieldConverter.toDb);var q=m.data[i.name];if(q)for(var l=0;l<q.length;l++)q[l]=c._typeFactory(i.elementType,q[l],c.fieldConverter.toDb)}else m.data[i.name]=c._typeFactory(i.type,m.data[i.name],c.fieldConverter.toDb);m.data[i.name]&&m.data[i.name].initData&&
(m.data[i.name]=m.data[i.name].initData)}}e.push(m.data)}g.insert(e,{safe:!0},function(i,h){if(i)b.error(i);else{for(var e=0;e<h.length;e++)for(var m=h[e],k=f.insertAll[e],l=Container.resolveType(k.type).memberDefinitions.getPublicMappedProperties(),p=0;p<l.length;p++){var j=l[p];k.entity[j.name]=c._typeFactory(j.type,m[j.computed?"_id":j.name],c.fieldConverter.fromDb)}d+=h.length;f.removeAll&&f.removeAll.length?s(a,f,g):f.updateAll&&f.updateAll.length?n(a,f,g):r(a,d)}})},n=function(a,e,h){g=e.updateAll.length;
for(var p=0;p<e.updateAll.length;p++){for(var j=e.updateAll[p],m={},o=Container.resolveType(j.type).memberDefinitions.getKeyProperties(),k=0;k<o.length;k++){var i=o[k];m[i.computed?"_id":i.name]=c.fieldConverter.toDb[Container.resolveName(Container.resolveType(i.type))](j.entity[i.name])}for(var q={},o=Container.resolveType(j.type).memberDefinitions.getPublicMappedProperties(),k=0;k<o.length;k++){var l=o[k];if(l.concurrencyMode===$data.ConcurrencyMode.Fixed)m[l.name]=c._typeFactory(l.type,j.entity[l.name],
c.fieldConverter.toDb),q.$inc||(q.$inc={}),q.$inc[l.name]=1;else if(!l.computed&&"undefined"!==typeof j.entity[l.name])if(Container.resolveType(l.type)===$data.Array&&l.elementType&&Container.resolveType(l.elementType)===$data.ObjectID){q[l.name]=c._typeFactory(l.type,j.entity[l.name],c.fieldConverter.toDb);var n=q[l.name];if(n)for(i=0;i<n.length;i++)n[i]=c._typeFactory(l.elementType,n[i],c.fieldConverter.toDb)}else q[l.name]=c._typeFactory(l.type,j.entity[l.name],c.fieldConverter.toDb)}(function(e){h.update(m,
{$set:q},{safe:!0},function(i,k){if(i)b.error(i);else if(k){d++;for(var l=Container.resolveType(e.type).memberDefinitions.getPublicMappedProperties(),j=0;j<l.length;j++){var p=l[j];p.concurrencyMode===$data.ConcurrencyMode.Fixed&&e.entity[p.name]++}f(function(){r(a,d)})}else g--,h.find({_id:m._id},{}).toArray(function(i,h){if(i)b.error(i);else{for(var g=h[0],k=Container.resolveType(e.type).memberDefinitions.getPublicMappedProperties(),l=0;l<k.length;l++){var j=k[l];e.entity[j.name]=c._typeFactory(j.type,
g[j.computed?"_id":j.name],c.fieldConverter.fromDb)}f(function(){r(a,d)})}})})})(j)}},s=function(a,e,h){g=e.removeAll.length;for(var p=0;p<e.removeAll.length;p++){for(var j=e.removeAll[p],m=Container.resolveType(j.type).memberDefinitions.getKeyProperties(),o=0;o<m.length;o++){var k=m[o];j.data[k.computed?"_id":k.name]=c.fieldConverter.toDb[Container.resolveName(Container.resolveType(k.type))](j.entity[k.name])}m=Container.resolveType(j.type).memberDefinitions.getPublicMappedProperties();for(o=0;o<
m.length;o++)k=m[o],k.computed||(j.data[k.name]=c.fieldConverter.toDb[Container.resolveName(Container.resolveType(k.type))](j.data[k.name]),"undefined"===typeof j.data[k.name]&&delete j.data[k.name]),k.concurrencyMode!==$data.ConcurrencyMode.Fixed&&delete j.data[k.name];h.remove(j.data,{safe:!0},function(c,j){c?b.error(c):(j?d++:g--,f(function(){e.updateAll&&e.updateAll.length?n(a,e,h):r(a,d)}))})}},t=Object.keys(a),r=function(d,h){if(t.length){var f=t.pop();if(a.hasOwnProperty(f)){var g=a[f],f=new c.driver.Collection(d,
f);g.insertAll&&g.insertAll.length?e(d,g,f):g.removeAll&&g.removeAll.length?s(d,g,f):g.updateAll&&g.updateAll.length?n(d,g,f):(b.success(0),d.close())}}else b.success(h),d.close()};(new this.driver.Db(this.providerConfiguration.databaseName,h,{})).open(function(a,d){a?b.error(a):c.providerConfiguration.username?d.authenticate(c.providerConfiguration.username,c.providerConfiguration.password,function(a,c){a?b.error(a):c&&r(d)}):r(d)})},saveChanges:function(b,a){if(a.length){for(var c=this.buildIndependentBlocks(a),
d=[],h={},g=0;g<c.length;g++)for(var f=0;f<c[g].length;f++){d.push(c[g][f].data);var e=h[c[g][f].entitySet.name];e||(e={},h[c[g][f].entitySet.name]=e);var n={entity:c[g][f].data,data:this.save_getInitData(c[g][f],d),type:Container.resolveName(c[g][f].data.getType())};switch(c[g][f].data.entityState){case $data.EntityState.Unchanged:continue;case $data.EntityState.Added:e.insertAll||(e.insertAll=[]);e.insertAll.push(n);break;case $data.EntityState.Modified:e.updateAll||(e.updateAll=[]);e.updateAll.push(n);
break;case $data.EntityState.Deleted:e.removeAll||(e.removeAll=[]);e.removeAll.push(n);break;default:Guard.raise(new Exception("Not supported Entity state"))}}this._saveCollections(b,h)}else b.success(0)},save_getInitData:function(b,a){b.physicalData=this.context._storageModel.getStorageModel(b.data.getType()).PhysicalType.convertTo(b.data,a);var c={};b.physicalData.getType().memberDefinitions.asArray().forEach(function(a){if(a.kind==$data.MemberTypes.navProperty||a.kind==$data.MemberTypes.complexProperty||
a.kind==$data.MemberTypes.property&&!a.notMapped)Container.resolveType(a.type)===$data.Array&&a.kind===$data.MemberTypes.property&&b.physicalData[a.name]?c[a.name]=JSON.parse(JSON.stringify(b.physicalData[a.name])):c[a.computed?"_id":a.name]=b.physicalData[a.name]},this);return c},supportedDataTypes:{value:[$data.Integer,$data.String,$data.Number,$data.Blob,$data.Boolean,$data.Date,$data.ObjectID,$data.Object,$data.Geography],writable:!1},supportedBinaryOperators:{value:{equal:{mapTo:":",dataType:"boolean",
allowedIn:[$data.Expressions.FilterExpression]},notEqual:{mapTo:"$ne",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},equalTyped:{mapTo:":",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},notEqualTyped:{mapTo:"$ne",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},greaterThan:{mapTo:"$gt",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},greaterThanOrEqual:{mapTo:"$gte",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},
lessThan:{mapTo:"$lt",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},lessThenOrEqual:{mapTo:"$lte",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},or:{mapTo:"$or",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},and:{mapTo:"$and",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},"in":{mapTo:"$in",allowedIn:[$data.Expressions.FilterExpression]}}},supportedUnaryOperators:{value:{not:{mapTo:"$nor"}}},supportedFieldOperations:{value:{contains:{dataType:"boolean",
allowedIn:[$data.Expressions.FilterExpression],parameters:[{name:"substring",dataType:"string"}]},startsWith:{dataType:"string",allowedIn:[$data.Expressions.FilterExpression],parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]},endsWith:{dataType:"string",allowedIn:[$data.Expressions.FilterExpression],parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]}},enumerable:!0,writable:!0},supportedSetOperations:{value:{filter:{},
map:{},length:{},forEach:{},toArray:{},batchDelete:{},single:{},take:{},skip:{},orderBy:{},orderByDescending:{},first:{}},enumerable:!0,writable:!0},fieldConverter:{value:{fromDb:{"$data.Integer":function(b){return b},"$data.Number":function(b){return b},"$data.Date":function(b){return b?new Date(b):b},"$data.String":function(b){return b},"$data.Boolean":function(b){return b},"$data.Blob":function(b){return b},"$data.Object":function(b){return void 0===b?new $data.Object:b},"$data.Array":function(b){return void 0===
b?new $data.Array:b},"$data.ObjectID":function(b){return b?(new Buffer(b.toString(),"ascii")).toString("base64"):b},"$data.Geography":function(b){return b?new $data.Geography(b[0],b[1]):b}},toDb:{"$data.Integer":function(b){return b},"$data.Number":function(b){return b},"$data.Date":function(b){return b},"$data.String":function(b){return b},"$data.Boolean":function(b){if("string"===typeof b)switch(b){case "true":case "true":case "TRUE":case "yes":case "Yes":case "YES":return!0;default:return!1}return null===
b||void 0===b?null:!!b},"$data.Blob":function(b){return b},"$data.Object":function(b){return b},"$data.Array":function(b){return b},"$data.ObjectID":function(b){return b&&"string"===typeof b?new $data.mongoDBDriver.ObjectID.createFromHexString((new Buffer(b,"base64")).toString("ascii")):b},"$data.Geography":function(b){return b?[b.longitude,b.latitude]:b}}}}},{isSupported:{get:function(){return!$data.mongoDBDriver?!1:!0},set:function(){}}});
$data.storageProviders.mongoDB.mongoDBProvider.isSupported&&$data.StorageProviderBase.registerProvider("mongoDB",$data.storageProviders.mongoDB.mongoDBProvider);try{"undefined"===typeof navigator&&(navigator=window.navigator=require("navigator"))}catch(err){}"undefined"===typeof btoa&&(btoa=window.btoa=function(b){return(new Buffer(b,"ascii")).toString("base64")});
$data.Class.define("$data.storageProviders.mongoDB.mongoDBProvider.ClientObjectID",null,null,{constructor:function(){var b=Math.floor((new Date).getTime()/1E3).toString(16),a=btoa(navigator?navigator.userAgent:"nodejs"),c=(a.charCodeAt(0)+a.charCodeAt(1)).toString(16)+(a.charCodeAt(2)+a.charCodeAt(3)).toString(16)+(a.charCodeAt(4)+a.charCodeAt(5)).toString(16),d=("0000"+Math.floor(Math.random()*65535).toString(16)).slice(-4),h=("000000"+(++$data.storageProviders.mongoDB.mongoDBProvider.ClientObjectID.idSeed).toString(16)).slice(-6);
this.toString=this.toLocaleString=this.valueOf=function(){return btoa(b+c+d+h)}},value:{value:null}},{idSeed:{value:Math.floor(255*Math.random())}});
